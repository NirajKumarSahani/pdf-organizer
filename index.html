<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Organizer Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js: Renders PDF pages into a canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <!-- pdf-lib: A powerful library for creating and modifying PDFs -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <!-- SortableJS: For drag-and-drop functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Style for the dragged item */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #c0d9ff;
        }
        /* Style for the item being dragged */
        .sortable-chosen {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: scale(1.05);
        }
        .page-thumbnail.deleted {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="w-full max-w-7xl mx-auto p-4 md:p-6">
        <header class="text-center mb-6 bg-white p-6 rounded-xl shadow-md">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">PDF Organizer</h1>
            <p class="text-gray-500 mt-2">Rearrange, rotate, and delete pages in your PDF with ease.</p>
        </header>

        <!-- File Upload Section -->
        <div id="upload-container" class="w-full bg-white rounded-xl shadow-lg p-6 md:p-8 text-center">
            <label for="pdf-upload" class="cursor-pointer group block w-full border-2 border-dashed border-gray-300 rounded-lg p-10 hover:border-blue-500 transition duration-300">
                <div class="flex flex-col items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400 group-hover:text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                    <p class="mt-4 text-lg text-gray-600">Drag & drop your PDF here or</p>
                    <p class="mt-2 text-blue-600 font-semibold">Click to select a file</p>
                    <p id="file-name-display" class="mt-4 text-gray-700 font-medium"></p>
                </div>
            </label>
            <input type="file" id="pdf-upload" class="hidden" accept=".pdf">
        </div>

        <!-- Organizer UI -->
        <div id="organizer-container" class="hidden">
            <!-- Action Buttons -->
            <div class="bg-white p-4 rounded-xl shadow-lg mb-6 flex flex-wrap items-center justify-center gap-4 sticky top-4 z-10">
                <button id="save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-md flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z" />
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-7-8a7 7 0 1114 0 7 7 0 01-14 0z" clip-rule="evenodd" />
                    </svg>
                    Save & Download PDF
                </button>
                 <button id="reset-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5M4 20h5v-5M20 4h-5v5" />
                    </svg>
                    Start Over
                </button>
            </div>
            <!-- Page Thumbnails Grid -->
            <div id="thumbnail-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                <!-- Thumbnails will be injected here -->
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center">
        <div class="flex flex-col items-center">
            <div id="loader" class="w-16 h-16 border-4 border-gray-200 rounded-full"></div>
            <p id="loader-text" class="text-white text-xl mt-4">Processing...</p>
        </div>
    </div>

    <script>
        // Set the workerSrc for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        // DOM Elements
        const uploadContainer = document.getElementById('upload-container');
        const pdfUploadInput = document.getElementById('pdf-upload');
        const fileNameDisplay = document.getElementById('file-name-display');
        const organizerContainer = document.getElementById('organizer-container');
        const thumbnailGrid = document.getElementById('thumbnail-grid');
        const saveBtn = document.getElementById('save-btn');
        const resetBtn = document.getElementById('reset-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loaderText = document.getElementById('loader-text');

        let originalFile = null;

        // --- Event Listeners ---
        pdfUploadInput.addEventListener('change', handleFileSelect);
        saveBtn.addEventListener('click', savePdf);
        resetBtn.addEventListener('click', resetUI);
        
        // --- Functions ---
        
        function showModalAlert(title, message) {
            let existingModal = document.getElementById('custom-alert-modal');
            if (existingModal) existingModal.remove();

            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'custom-alert-modal';
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-center';
            
            const modalTitle = document.createElement('h2');
            modalTitle.className = 'text-xl font-bold text-gray-800 mb-2';
            modalTitle.textContent = title;

            const modalMessage = document.createElement('p');
            modalMessage.className = 'text-gray-600 mb-4';
            modalMessage.textContent = message;
            
            const closeButton = document.createElement('button');
            closeButton.className = 'bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300';
            closeButton.textContent = 'OK';
            closeButton.onclick = () => modalOverlay.remove();
            
            modalContent.appendChild(modalTitle);
            modalContent.appendChild(modalMessage);
            modalContent.appendChild(closeButton);
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);
            closeButton.focus();
        }

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'application/pdf') {
                showModalAlert('Invalid File Type', 'Please select a valid PDF file.');
                return;
            }
            
            originalFile = file;
            fileNameDisplay.textContent = `Selected: ${originalFile.name}`;
            
            showLoader(true, 'Reading and rendering pages...');
            
            try {
                const fileReader = new FileReader();
                fileReader.onload = async (e) => {
                    const typedarray = new Uint8Array(e.target.result);
                    await renderPdfPages(typedarray);
                    uploadContainer.classList.add('hidden');
                    organizerContainer.classList.remove('hidden');
                    initializeSortable();
                    showLoader(false);
                };
                fileReader.readAsArrayBuffer(originalFile);
            } catch (error) {
                console.error('Error processing PDF:', error);
                showModalAlert('Error', 'Could not process the PDF file. It may be corrupted or password-protected.');
                resetUI();
                showLoader(false);
            }
        }

        async function renderPdfPages(pdfData) {
            thumbnailGrid.innerHTML = ''; // Clear previous
            const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
            
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 0.5 }); // Low-res for thumbnails
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({ canvasContext: context, viewport: viewport }).promise;

                const thumbnailDiv = document.createElement('div');
                thumbnailDiv.className = 'page-thumbnail group relative bg-white p-2 rounded-lg shadow-md border border-gray-200 cursor-grab transition-all duration-300';
                // Store original page number (1-based index)
                thumbnailDiv.dataset.originalIndex = i - 1; 
                
                thumbnailDiv.innerHTML = `
                    <img src="${canvas.toDataURL()}" class="w-full h-auto rounded-md" alt="Page ${i}">
                    <div class="absolute bottom-2 left-2 bg-black bg-opacity-60 text-white text-xs font-bold px-2 py-1 rounded">${i}</div>
                    <button class="delete-btn absolute top-2 right-2 bg-red-500 hover:bg-red-700 text-white rounded-full h-6 w-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                `;
                thumbnailGrid.appendChild(thumbnailDiv);
            }

            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.target.closest('.page-thumbnail').classList.add('deleted');
                });
            });
        }
        
        function initializeSortable() {
            new Sortable(thumbnailGrid, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
            });
        }

        async function savePdf() {
            if (!originalFile) return;

            showLoader(true, 'Rebuilding your PDF...');

            try {
                const { PDFDocument } = PDFLib;
                const existingPdfBytes = await originalFile.arrayBuffer();
                const pdfDoc = await PDFDocument.load(existingPdfBytes, { ignoreEncryption: true });
                const newPdfDoc = await PDFDocument.create();

                const visibleThumbnails = Array.from(thumbnailGrid.querySelectorAll('.page-thumbnail:not(.deleted)'));
                
                if(visibleThumbnails.length === 0){
                   showModalAlert('Error', 'Cannot save an empty PDF. At least one page must be visible.');
                   showLoader(false);
                   return;
                }
                
                const originalIndicesToCopy = visibleThumbnails.map(thumb => parseInt(thumb.dataset.originalIndex));
                
                const copiedPages = await newPdfDoc.copyPages(pdfDoc, originalIndicesToCopy);
                
                copiedPages.forEach(page => newPdfDoc.addPage(page));

                const pdfBytes = await newPdfDoc.save();

                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `organized-${originalFile.name}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showLoader(false);

            } catch (error) {
                console.error("Failed to save PDF:", error);
                showLoader(false);
                showModalAlert('Save Failed', 'An error occurred while creating the new PDF.');
            }
        }

        function resetUI() {
            originalFile = null;
            pdfUploadInput.value = '';
            fileNameDisplay.textContent = '';
            thumbnailGrid.innerHTML = '';
            organizerContainer.classList.add('hidden');
            uploadContainer.classList.remove('hidden');
        }

        function showLoader(show, message = 'Processing...') {
            loaderText.textContent = message;
            loadingOverlay.classList.toggle('hidden', !show);
        }
    </script>

</body>
</html>
